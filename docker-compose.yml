version: "3.8"
services:
  mitmproxy:
    image: mitmproxy/mitmproxy:latest
    command: mitmweb --web-host 0.0.0.0 --set web_password='mitm' 
    ports:
      - "8080:8080"
      - "8081:8081"

    volumes:
      - mitm_data:/home/mitmproxy/.mitmproxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "test -f /home/mitmproxy/.mitmproxy/mitmproxy-ca-cert.pem || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 20

  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    depends_on:
      mitmproxy:
        condition: service_healthy
    environment:
      - HTTP_PROXY=http://mitmproxy:8080
      - http_proxy=http://mitmproxy:8080
      - HTTPS_PROXY=http://mitmproxy:8080
      - https_proxy=http://mitmproxy:8080
      - NODE_EXTRA_CA_CERTS=/home/mitmproxy/mitmproxy-ca-cert.pem
      - MITM_ENABLED=true
      - MITM_CA_PATH=/home/mitmproxy/mitmproxy-ca-cert.pem
    volumes:
      - ./:/usr/src/app:cached
      - mitm_data:/home/mitmproxy:ro
    working_dir: /usr/src/app
    ports:
      - "3000:3000"
    command: sh -lc "npm install && npm run dev"
    restart: unless-stopped

volumes:
  mitm_data:
    name: mitm_data
